name: Auto Release MCP server

on:
  push:
    branches:
      - main
    paths:
      - 'edda/edda_mcp/Cargo.toml'
  pull_request:
    paths:
      - 'edda/edda_mcp/Cargo.toml'

permissions:
  contents: write
  actions: read

jobs:
  detect-version:
    name: Detect Version and Validate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      should_release: ${{ steps.check.outputs.should_release }}
      commit_sha: ${{ steps.extract.outputs.commit_sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Extract version from Cargo.toml
        id: extract
        run: |
          VERSION=$(grep '^version = ' edda/edda_mcp/Cargo.toml | head -n1 | sed 's/version = "\(.*\)"/\1/')
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Check release conditions
        id: check
        run: |
          VERSION="${{ steps.extract.outputs.version }}"
          should_release="false"

          # Check if this is a PR - require [release] keyword
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Check all commits in the PR, not just the merge commit
            if git log --format=%B origin/${{ github.base_ref }}..HEAD | grep -q "\[release\]"; then
              echo "PR with [release] keyword detected"
              should_release="true"
            else
              echo "PR without [release] keyword - skipping release"
              should_release="false"
            fi
          else
            # Push to main - always attempt release
            should_release="true"
          fi

          echo "should_release=$should_release" >> $GITHUB_OUTPUT

      - name: Validate version format
        if: steps.check.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.extract.outputs.version }}"

          # Check if this is a PR or push to main
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PR releases must have -dev prefix
            if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-dev ]]; then
              echo "Error: PR releases must use dev version format (e.g., 0.0.3-dev.1)"
              echo "Found: $VERSION"
              exit 1
            fi
          else
            # Main branch releases must NOT have any suffix
            if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Error: Main branch releases must follow format 0.0.0 (no suffix)"
              echo "Found: $VERSION"
              exit 1
            fi
          fi

      - name: Check if tag already exists (fail explicitly)
        if: steps.check.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.extract.outputs.version }}"
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Error: Tag v$VERSION already exists!"
            echo "Please bump the version in edda/edda_mcp/Cargo.toml before releasing."
            exit 1
          fi
          echo "Tag v$VERSION does not exist - proceeding with release"

  find-artifacts:
    name: Find CI Artifacts
    runs-on: ubuntu-latest
    needs: detect-version
    if: needs.detect-version.outputs.should_release == 'true'
    outputs:
      run_id: ${{ steps.find_run.outputs.run_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Find successful CI run for commit
        id: find_run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMIT_SHA="${{ needs.detect-version.outputs.commit_sha }}"
          echo "Finding CI run for commit $COMMIT_SHA..."

          RUN_ID=$(gh run list --commit "$COMMIT_SHA" \
            --workflow="Rust" \
            --status=success \
            --json databaseId \
            --jq '.[0].databaseId')

          if [ -z "$RUN_ID" ]; then
            echo "Error: No successful CI run found for commit $COMMIT_SHA"
            echo "Make sure the Rust CI workflow has completed successfully"
            exit 1
          fi

          echo "Found CI run: $RUN_ID"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [detect-version, find-artifacts]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: edda-mcp-linux-x86_64
          path: artifacts/linux
          run-id: ${{ needs.find-artifacts.outputs.run_id }}
          github-token: ${{ github.token }}

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: edda-mcp-macos-arm64
          path: artifacts/macos
          run-id: ${{ needs.find-artifacts.outputs.run_id }}
          github-token: ${{ github.token }}

      - name: Prepare artifacts for release
        run: |
          mkdir -p release
          mv artifacts/linux/edda_mcp release/edda_mcp-linux-x86_64
          mv artifacts/macos/edda_mcp release/edda_mcp-macos-arm64
          chmod +x release/*
          ls -lh release/

      - name: Create git tag
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          COMMIT_SHA="${{ needs.detect-version.outputs.commit_sha }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag "v$VERSION" "$COMMIT_SHA"
          git push origin "v$VERSION"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          COMMIT_SHA="${{ needs.detect-version.outputs.commit_sha }}"
          CI_URL="https://github.com/${{ github.repository }}/actions/runs/${{ needs.find-artifacts.outputs.run_id }}"

          # Generate checksums
          cd release
          LINUX_CHECKSUM=$(sha256sum edda_mcp-linux-x86_64 | awk '{print $1}')
          MACOS_CHECKSUM=$(sha256sum edda_mcp-macos-arm64 | awk '{print $1}')
          cd ..

          cat > release_notes.md <<EOF
          Release v$VERSION

          ## SHA256 Checksums
          \`\`\`
          $LINUX_CHECKSUM  edda_mcp-linux-x86_64
          $MACOS_CHECKSUM  edda_mcp-macos-arm64
          \`\`\`

          ---
          - Built from commit: \`$COMMIT_SHA\`
          - CI Run: $CI_URL
          EOF

          gh release create "v$VERSION" \
            --repo "${{ github.repository }}" \
            --title "v$VERSION" \
            --notes-file release_notes.md \
            --latest \
            release/*

      - name: Output release URL
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          echo "Release created successfully!"
          echo "View at: https://github.com/${{ github.repository }}/releases/tag/v$VERSION"
