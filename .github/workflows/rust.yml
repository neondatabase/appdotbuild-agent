name: Rust

on:
  push:
    branches:
      - main
  pull_request:

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  rust-checks:
    name: Check and Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: dabgent

      - name: Run cargo check all targets
        working-directory: ./dabgent
        run: cargo check --all-targets --workspace

      - name: Run cargo clippy
        working-directory: ./dabgent
        run: cargo clippy --workspace -- -W warnings
        continue-on-error: true

  rust-tests:
    name: Rust Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: dabgent

      - name: Run unit tests
        working-directory: ./dabgent
        run: cargo nextest run --lib --bins --workspace

      - name: Run integration tests
        working-directory: ./dabgent
        # Run with single thread due to Dagger connection race conditions
        run: cargo nextest run --tests --workspace --test-threads=1

  build-dabgent-mcp:
    name: Build dabgent_mcp (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 20
    needs: [rust-checks, rust-tests]
    strategy:
      matrix:
        include:
          - platform: linux-x86_64
            runner: ubuntu-latest
          - platform: macos-arm64
            runner: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Determine if Release Build is Needed
        id: check_release
        run: |
          is_release="false"
          # we check two commits because the first commit is the merge commit
          if git log -2 --pretty=%s | tail -n 1 | grep -q "release"; then
            is_release="true"
            echo "Release build detected based on commit message."
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            is_release="true"
            echo "Release build detected based on push to main branch."
          fi

          echo "is_release=${is_release}" >> $GITHUB_OUTPUT

      - name: Setup Rust
        if: steps.check_release.outputs.is_release == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        if: steps.check_release.outputs.is_release == 'true'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: dabgent

      - name: Build release binary
        if: steps.check_release.outputs.is_release == 'true'
        working-directory: ./dabgent
        run: cargo build --release -p dabgent_mcp

      - name: Upload binary artifact
        if: steps.check_release.outputs.is_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dabgent-mcp-${{ matrix.platform }}
          path: dabgent/target/release/dabgent-mcp
          retention-days: 30
